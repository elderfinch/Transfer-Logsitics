<!doctype html>
<html lang="en" data-theme="winter">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Transfer Logistics</title>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.css" rel="stylesheet" type="text/css" />
  <script src="https://cdn.tailwindcss.com"></script>
  
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { 
        padding-bottom: 100px; /* Add padding to prevent FAB from overlapping content */
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
    }
    .container { width: 95%; max-width: initial; }
    .btn-group {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    .hidden-file-input { display: none; }
    .table th:first-child, .table td:first-child {
        position: sticky;
        left: 0;
        background: inherit;
        z-index: 1;
    }
    .hidden-input { display: none; margin-top: 10px !important; }
  </style>
</head>
<body>
  <div class="navbar bg-primary text-primary-content sticky top-0 z-30">
    <div class="navbar-start">
      <button class="btn btn-ghost btn-circle" onclick="modal_settings.showModal()">
        <i class="fa fa-cog text-xl"></i>
      </button>
    </div>
    <div class="navbar-center">
      <a class="btn btn-ghost text-xl" data-translate="app_title">Transfer Logistics</a>
    </div>
    <div class="navbar-end">
        <div class="dropdown dropdown-end">
            <div tabindex="0" role="button" class="btn btn-ghost">Theme <svg width="12px" height="12px" class="h-2 w-2 fill-current opacity-60 inline-block" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 2048 2048"><path d="M1799 349l242 241-1017 1017L7 590l242-241 775 775 775-775z"></path></svg></div>
            <ul tabindex="0" id="theme-menu" class="dropdown-content z-[50] max-h-[65vh] overflow-y-auto flex-nowrap menu p-2 shadow-2xl bg-base-200 rounded-box w-52">
                <li><a>light</a></li><li><a>dark</a></li><li><a>cupcake</a></li><li><a>bumblebee</a></li><li><a>emerald</a></li><li><a>corporate</a></li><li><a>synthwave</a></li><li><a>retro</a></li><li><a>cyberpunk</a></li><li><a>valentine</a></li><li><a>halloween</a></li><li><a>garden</a></li><li><a>forest</a></li><li><a>aqua</a></li><li><a>lofi</a></li><li><a>pastel</a></li><li><a>fantasy</a></li><li><a>wireframe</a></li><li><a>black</a></li><li><a>luxury</a></li><li><a>dracula</a></li><li><a>cmyk</a></li><li><a>autumn</a></li><li><a>business</a></li><li><a>acid</a></li><li><a>lemonade</a></li><li><a>night</a></li><li><a>coffee</a></li><li><a>winter</a></li><li><a>dim</a></li><li><a>nord</a></li><li><a>sunset</a></li>
            </ul>
        </div>
    </div>
  </div>

  <main class="container mx-auto p-4">
    <div class="my-8">
      <div id="upload-section">
        <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
            <h2 class="text-2xl font-bold" data-translate="upload_title">Start New Plan</h2>
            <label class="form-control w-full max-w-xs">
              <div class="label"><span class="label-text" data-translate="language">Language</span></div>
              <select class="select select-bordered lang-select">
                <option value="en">English</option>
                <option value="pt">Português</option>
              </select>
            </label>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <label class="form-control w-full">
              <div class="label"><span class="label-text" data-translate="old_board_label">Old transferboard (from)</span></div>
              <input id="file-old" type="file" class="file-input file-input-bordered w-full" accept=".xlsx,.xls,.csv" />
            </label>
            <label class="form-control w-full">
              <div class="label"><span class="label-text" data-translate="new_board_label">New transferboard (to)</span></div>
              <input id="file-new" type="file" class="file-input file-input-bordered w-full" accept=".xlsx,.xls,.csv" />
            </label>
        </div>
        <button id="btn-process" class="btn btn-primary mt-4" data-translate="process_upload">Process upload</button>
        <div class="divider my-8">OR</div>
        <h2 class="text-2xl font-bold" data-translate="restore_title">Restore Plan from CSV</h2>
        <div class="flex items-end gap-4 mt-4 flex-wrap">
            <label class="form-control w-full flex-grow">
              <div class="label"><span class="label-text" data-translate="restore_desc">Upload travel_plans.csv file to restore progress</span></div>
              <input id="file-restore" type="file" class="file-input file-input-bordered w-full" accept=".csv" />
            </label>
            <button id="btn-restore" class="btn" data-translate="restore_button">Restore</button>
        </div>
      </div>

      <div class="btn-group" style="display: none;">
          <button id="btn-export-pdf" class="btn btn-success" data-translate="export_pdf">Export PDF</button>
          <button id="btn-export-csv" class="btn btn-info" data-translate="export_csv">Export CSV</button>
          <button id="btn-update-origins" class="btn btn-warning" data-translate="update_origin_areas_btn">Update Origin Areas</button>
          <input type="file" id="file-update-origin" class="hidden-file-input" accept=".xlsx,.xls,.csv" />
          <button id="btn-clear-local" class="btn btn-error" data-translate="clear_all_travel">Clear All Saved Travel</button>
      </div>
    </div>

    <div class="my-8">
      <h2 class="text-2xl font-bold mb-4" data-translate="groups_title">Groups</h2>
      <div id="groups" class="space-y-6"></div>
    </div>

    <div class="fixed bottom-8 right-8 z-40">
      <button class="btn btn-primary btn-circle btn-lg" onclick="modal_add.showModal()">
        <i class="fa fa-plus text-2xl"></i>
      </button>
    </div>
  </main>
  
  <div id="toast-container" class="toast toast-top toast-center z-50"></div>

  <dialog id="modal_add" class="modal">
    <div class="modal-box w-11/12 max-w-5xl">
      <h3 class="font-bold text-lg" data-translate="add_missionary_title">Add Missionary</h3>
      <div class="py-4 space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
              <label class="form-control"><div class="label"><span class="label-text" data-translate="type">Type</span></div><select id="add-type" class="select select-bordered"><option disabled selected data-translate="choose_option">Choose...</option><option>Elder</option><option>Sister</option></select></label>
              <label class="form-control"><div class="label"><span class="label-text" data-translate="name">Name</span></div><input id="add-name" type="text" placeholder="Last, First" class="input input-bordered" /></label>
              <label class="form-control"><div class="label"><span class="label-text" data-translate="origin_city">Origin City</span></div><select id="add-origin-select" class="select select-bordered"></select><input id="add-origin-other" class="input input-bordered hidden-input" placeholder="Custom City" /></label>
              <label class="form-control"><div class="label"><span class="label-text" data-translate="dest_city">Destination City</span></div><select id="add-dest-select" class="select select-bordered"></select><input id="add-dest-other" class="input input-bordered hidden-input" placeholder="Custom City" /></label>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-12 gap-4">
              <label class="form-control col-span-3"><div class="label"><span class="label-text" data-translate="origin_area">Origin Area</span></div><input id="add-originarea" type="text" class="input input-bordered" /></label>
              <label class="form-control col-span-3"><div class="label"><span class="label-text" data-translate="dest_area">Destination Area</span></div><input id="add-destarea" type="text" class="input input-bordered" /></label>
              <label class="form-control col-span-4"><div class="label"><span class="label-text" data-translate="transportation">Transportation</span></div><select id="add-transport" class="select select-bordered"></select></label>
              <label class="form-control col-span-2"><div class="label"><span class="label-text" data-translate="date">Date</span></div><input id="add-date" type="date" class="input input-bordered" /></label>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-center">
              <label class="form-control"><div class="label"><span class="label-text" data-translate="departure_time">Departure Time</span></div><input id="add-time" type="time" class="input input-bordered" /></label>
              <label class="form-control col-span-2"><div class="label"><span class="label-text" data-translate="travel_instructions">Travel Instructions</span></div><input id="add-instructions" type="text" class="input input-bordered" /></label>
              <div class="flex space-x-4 pt-6">
                <label class="cursor-pointer label"><input type="checkbox" id="add-tbd" class="checkbox" /><span class="label-text ml-2" data-translate="tbd">TBD</span></label>
                <label class="cursor-pointer label"><input type="checkbox" id="add-new" class="checkbox" /><span class="label-text ml-2" data-translate="table_header_new">New</span></label>
                <label class="cursor-pointer label"><input type="checkbox" id="add-leader" class="checkbox" /><span class="label-text ml-2" data-translate="travel_leader">Travel Leader</span></label>
              </div>
          </div>
      </div>
      <div class="modal-action">
        <form method="dialog"><button id="btn-add-save" class="btn btn-primary" data-translate="save">Save</button><button class="btn">Close</button></form>
      </div>
    </div>
  </dialog>
  
  <dialog id="modal_edit" class="modal">
    <div class="modal-box w-11/12 max-w-5xl">
      <h3 class="font-bold text-lg" data-translate="edit_missionary_title">Edit Missionary</h3>
      <input type="hidden" id="edit-original-group-key"><input type="hidden" id="edit-missionary-id">
      <div class="py-4 space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
              <label class="form-control"><div class="label"><span class="label-text" data-translate="type">Type</span></div><select id="edit-type" class="select select-bordered"><option>Elder</option><option>Sister</option></select></label>
              <label class="form-control"><div class="label"><span class="label-text" data-translate="name">Name</span></div><input id="edit-name" type="text" placeholder="Last, First" class="input input-bordered" /></label>
              <label class="form-control"><div class="label"><span class="label-text" data-translate="origin_city">Origin City</span></div><select id="edit-origin-select" class="select select-bordered"></select><input id="edit-origin-other" class="input input-bordered hidden-input" placeholder="Custom City" /></label>
              <label class="form-control"><div class="label"><span class="label-text" data-translate="dest_city">Destination City</span></div><select id="edit-dest-select" class="select select-bordered"></select><input id="edit-dest-other" class="input input-bordered hidden-input" placeholder="Custom City" /></label>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-12 gap-4">
              <label class="form-control col-span-3"><div class="label"><span class="label-text" data-translate="origin_area">Origin Area</span></div><input id="edit-originarea" type="text" class="input input-bordered" /></label>
              <label class="form-control col-span-3"><div class="label"><span class="label-text" data-translate="dest_area">Destination Area</span></div><input id="edit-destarea" type="text" class="input input-bordered" /></label>
              <label class="form-control col-span-4"><div class="label"><span class="label-text" data-translate="transportation">Transportation</span></div><select id="edit-transport" class="select select-bordered"></select></label>
              <label class="form-control col-span-2"><div class="label"><span class="label-text" data-translate="date">Date</span></div><input id="edit-date" type="date" class="input input-bordered" /></label>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-center">
              <label class="form-control"><div class="label"><span class="label-text" data-translate="departure_time">Departure Time</span></div><input id="edit-time" type="time" class="input input-bordered" /></label>
              <label class="form-control col-span-2"><div class="label"><span class="label-text" data-translate="travel_instructions">Travel Instructions</span></div><input id="edit-instructions" type="text" class="input input-bordered" /></label>
              <div class="flex space-x-4 pt-6">
                <label class="cursor-pointer label"><input type="checkbox" id="edit-tbd" class="checkbox" /><span class="label-text ml-2" data-translate="tbd">TBD</span></label>
                <label class="cursor-pointer label"><input type="checkbox" id="edit-leader" class="checkbox" /><span class="label-text ml-2" data-translate="travel_leader">Travel Leader</span></label>
              </div>
          </div>
      </div>
      <div class="modal-action">
        <form method="dialog"><button id="btn-edit-save" class="btn btn-primary" data-translate="save">Save</button><button class="btn">Close</button></form>
      </div>
    </div>
  </dialog>
  
  <dialog id="modal_settings" class="modal">
    <div class="modal-box">
      <h3 class="font-bold text-lg" data-translate="settings">Settings</h3>
      <div class="py-4 space-y-4">
        <label class="form-control w-full max-w-xs"><div class="label"><span class="label-text" data-translate="language">Language</span></div><select class="select select-bordered lang-select"><option value="en">English</option><option value="pt">Português</option></select></label>
        <div class="divider"></div>
        <h4 class="font-bold" data-translate="exceptions_title">Area/District Exceptions</h4>
        <div id="exceptions-list" class="space-y-2"></div>
        <div class="divider"></div>
        <h4 class="font-bold" data-translate="add_exception_title">Add New Exception</h4>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <label class="form-control"><div class="label"><span class="label-text" data-translate="area_zone_name">Area/District/Zone Name</span></div><input id="ex-add-name" type="text" class="input input-bordered" /></label>
          <label class="form-control"><div class="label"><span class="label-text" data-translate="override_city">Override City</span></div><input id="ex-add-city" type="text" class="input input-bordered" /></label>
        </div>
        <button id="btn-save-exception" class="btn btn-secondary mt-2" data-translate="save">Save</button>
      </div>
      <div class="modal-action">
        <form method="dialog"><button class="btn">Close</button></form>
      </div>
    </div>
  </dialog>

  <dialog id="modal_map" class="modal">
    <div class="modal-box">
      <h3 class="font-bold text-lg" data-translate="map_columns_title">Map columns...</h3>
      <div id="mapping-forms" class="py-4 space-y-4"></div>
      <div class="modal-action">
        <form method="dialog"><button id="btn-map-apply" class="btn btn-primary" data-translate="apply_mapping">Apply Mapping</button></form>
      </div>
    </div>
  </dialog>

  <dialog id="modal_map_update" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg" data-translate="map_origin_areas_title">Map Origin Area Columns</h3>
        <p data-translate="map_origin_areas_desc">Select the columns for Missionary Name and their Origin Area.</p>
        <div id="mapping-forms-update" class="py-4 space-y-4"></div>
        <div class="modal-action">
            <form method="dialog"><button id="btn-map-update-apply" class="btn btn-primary">Apply Update</button></form>
        </div>
    </div>
  </dialog>

  <dialog id="modal_exceptions" class="modal">
    <div class="modal-box w-11/12 max-w-3xl">
      <h3 class="font-bold text-lg" data-translate="assign_exceptions_title">Assign exceptions...</h3>
      <p data-translate="assign_exceptions_desc">For any area or zone below, you can enter a city name to override the default. Check "Apply" to save the exception.</p>
      <div id="exceptions-assign" class="py-4 space-y-4"></div>
      <div class="modal-action">
        <form method="dialog"><button id="btn-exceptions-apply" class="btn btn-primary" data-translate="save_exceptions">Save Exceptions</button></form>
      </div>
    </div>
  </dialog>
  
  <dialog id="modal_transport_defaults" class="modal">
    <div class="modal-box">
      <h3 class="font-bold text-lg" data-translate="transport_defaults_title">Set Default Transportation</h5>
      <p data-translate="transport_defaults_desc">Select the default mode of transport for each travel group. This will be applied to all missionaries in that group.</p>
      <div id="transport-defaults-list" class="py-4 space-y-4"></div>
      <div class="modal-action">
        <form method="dialog"><button id="btn-transport-apply" class="btn btn-primary">Apply & Process</button></form>
      </div>
    </div>
  </dialog>

  <script>
    // -- Constants, Defaults & State
    const LS_KEY = 'transfer_logistics_data_v1';
    const THEME_KEY = 'transfer_logistics_theme_v1';
    const defaults = {
      exceptions: {
        'Quelimane': { city: 'Quelimane' },
        'Quelimane District': { city: 'Quelimane' },
        'Nhamatanda': { city: 'Nhamatanda' },
        'Marromeu': { city: 'Marromeu' },
        'Caia': { city: 'Caia' },
        'ZONA INHAMIZUA': { city: 'Beira' },
        'ZONA MANGA': { city: 'Beira' },
        'ZONA MUNHAVA': { city: 'Beira' }
      }
    };
    let state = loadFromLS() || { groups: {}, exceptions: defaults.exceptions, lang: 'pt' };
    let fileOldRows = null; let fileNewRows = null;
    let mapping = { name: null, type: null, area: null, district: null, zone: null };
    let pendingMissionaries = [];
    
    // -- Toast Notification
    function showToast(message, type = 'success') {
        const toastContainer = document.getElementById('toast-container');
        const alertType = type === 'error' ? 'alert-error' : 'alert-success';
        const toast = document.createElement('div');
        toast.className = `alert ${alertType} shadow-lg`;
        toast.innerHTML = `<span>${message}</span>`;
        toastContainer.appendChild(toast);
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 500);
        }, 3000);
    }

    // -- Theme Management
    function applyTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem(THEME_KEY, theme);
    }
    
    document.getElementById('theme-menu').addEventListener('click', (e) => {
        if (e.target.tagName === 'A') {
            applyTheme(e.target.textContent.trim().toLowerCase());
        }
    });

    // -- Translations
    const translations = {
        en: {
            app_title: "Transfer Logistics",
            upload_title: "Start New Plan",
            restore_title: "Restore Plan from CSV",
            restore_desc: "Upload travel_plans.csv file to restore progress",
            restore_button: "Restore",
            old_board_label: "Old transferboard (from)",
            new_board_label: "New transferboard (to)",
            process_upload: "Process upload",
            export_pdf: "Export PDF",
            export_csv: "Export CSV",
            update_origin_areas_btn: "Update Origin Areas",
            clear_all_travel: "Clear All Saved Travel",
            groups_title: "Groups",
            add_missionary_title: "Add Missionary",
            edit_missionary_title: "Edit Missionary",
            type: "Type",
            name: "Name",
            origin_city: "Origin City",
            dest_city: "Destination City",
            origin_area: "Origin Area",
            dest_area: "Destination Area",
            transportation: "Transportation",
            date: "Date",
            tbd: "TBD",
            departure_time: "Departure Time",
            travel_instructions: "Travel Instructions",
            travel_leader: "Travel Leader",
            save: "Save",
            settings: "Settings",
            language: "Language",
            delete_all_travel: "Delete All Missionary Travel",
            exceptions_title: "Area/District Exceptions",
            add_exception_title: "Add New Exception",
            area_zone_name: "Area/District/Zone Name",
            override_city: "Override City",
            map_columns_title: "Map columns (choose which column in your spreadsheet corresponds to these fields)",
            map_origin_areas_title: "Map Origin Area Columns",
            map_origin_areas_desc: "Select the columns for Missionary Name and their Origin Area.",
            apply_mapping: "Apply Mapping",
            assign_exceptions_title: "Assign exceptions (areas/districts that map to a different city)",
            assign_exceptions_desc: "For any area or zone below, you can enter a city name to override the default. Check 'Apply' to save the exception.",
            save_exceptions: "Save Exceptions",
            transport_defaults_title: "Set Default Transportation",
            transport_defaults_desc: "Select the default mode of transport for each travel group. This will be applied to all missionaries in that group.",
            table_header_type: "Type",
            table_header_name: "Name",
            table_header_new: "New",
            table_header_origin_area: "Origin Area",
            table_header_dest_area: "Destination Area",
            table_header_transport: "Transportation",
            table_header_date: "Date",
            table_header_time: "Time",
            table_header_instructions: "Instructions",
            table_header_leader: "Leader",
            table_header_actions: "Actions",
            bulk_edit_title: "Bulk Edit for This Group:",
            bulk_edit_instructions_placeholder: "Set instructions for all",
            bulk_edit_transport_placeholder: "Set Transport",
            toast_select_files: "Please select both files",
            toast_restore_file: "Please select a CSV file to restore",
            toast_processed: "Processed {count} missionaries (transfers and new arrivals).",
            toast_added: "Added",
            toast_restored: "Plan restored successfully.",
            toast_origins_updated: "Origin areas updated successfully.",
            toast_updated: "Updated {field} for all in group.",
            toast_pdf_generating: "Generating PDF... Please wait.",
            toast_pdf_generated: "PDF generated successfully.",
            confirm_remove_missionary: "Remove this missionary from travel plans?",
            confirm_delete_all: "Delete ALL missionary travel? This will clear saved groups.",
            confirm_clear_local: "Clear local storage? This will delete all saved travel and settings.",
            transport_bus: "Bus",
            transport_plane: "Plane",
            transport_chapa: "Chapa",
            transport_taxi: "Txopela/Taxi",
            transport_ride: "Ride",
            choose_option: "Choose...",
            other_option: "Other..."
        },
        pt: {
            app_title: "Logística de Transferência",
            upload_title: "Iniciar Novo Plano",
            restore_title: "Restaurar Plano do CSV",
            restore_desc: "Carregar ficheiro travel_plans.csv para restaurar o progresso",
            restore_button: "Restaurar",
            old_board_label: "Quadro de transferência antigo (de)",
            new_board_label: "Quadro de transferência novo (para)",
            process_upload: "Processar carregamento",
            export_pdf: "Exportar PDF",
            export_csv: "Exportar CSV",
            update_origin_areas_btn: "Atualizar Áreas de Origem",
            clear_all_travel: "Limpar Viagens Guardadas",
            groups_title: "Grupos",
            add_missionary_title: "Adicionar Missionário",
            edit_missionary_title: "Editar Missionário",
            type: "Tipo",
            name: "Nome",
            origin_city: "Cidade de Origem",
            dest_city: "Cidade de Destino",
            origin_area: "Área de Origem",
            dest_area: "Área de Destino",
            transportation: "Transporte",
            date: "Data",
            tbd: "A Definir",
            departure_time: "Hora de Partida",
            travel_instructions: "Instruções de Viagem",
            travel_leader: "Líder de Viagem",
            save: "Guardar",
            settings: "Definições",
            language: "Idioma",
            delete_all_travel: "Apagar Todas as Viagens de Missionários",
            exceptions_title: "Exceções de Área/Distrito",
            add_exception_title: "Adicionar Nova Exceção",
            area_zone_name: "Nome da Área/Distrito/Zona",
            override_city: "Cidade Alternativa",
            map_columns_title: "Mapear colunas (escolha qual coluna da sua planilha corresponde a estes campos)",
            map_origin_areas_title: "Mapear Colunas da Área de Origem",
            map_origin_areas_desc: "Selecione as colunas para o Nome do Missionário e a sua Área de Origem.",
            apply_mapping: "Aplicar Mapeamento",
            assign_exceptions_title: "Atribuir exceções (áreas/distritos que mapeiam para uma cidade diferente)",
            assign_exceptions_desc: "Para qualquer área ou zona abaixo, pode inserir um nome de cidade para substituir o padrão. Marque 'Aplicar' para guardar a exceção.",
            save_exceptions: "Guardar Exceções",
            transport_defaults_title: "Definir Transporte Padrão",
            transport_defaults_desc: "Selecione o modo de transporte padrão para cada grupo de viagem. Isso será aplicado a todos os missionários desse grupo.",
            table_header_type: "Tipo",
            table_header_name: "Nome",
            table_header_new: "Novo",
            table_header_origin_area: "Área de Origem",
            table_header_dest_area: "Área de Destino",
            table_header_transport: "Transporte",
            table_header_date: "Data",
            table_header_time: "Hora",
            table_header_instructions: "Instruções",
            table_header_leader: "Líder",
            table_header_actions: "Ações",
            bulk_edit_title: "Edição em Massa para Este Grupo:",
            bulk_edit_instructions_placeholder: "Definir instruções para todos",
            bulk_edit_transport_placeholder: "Definir Transporte",
            toast_select_files: "Por favor, selecione ambos os ficheiros",
            toast_restore_file: "Por favor, selecione um ficheiro CSV para restaurar",
            toast_processed: "Processados {count} missionários (transferências e novas chegadas).",
            toast_added: "Adicionado",
            toast_restored: "Plano restaurado com sucesso.",
            toast_origins_updated: "Áreas de origem atualizadas com sucesso.",
            toast_updated: "{field} atualizado para todos no grupo.",
            toast_pdf_generating: "A gerar PDF... Por favor, aguarde.",
            toast_pdf_generated: "PDF gerado com sucesso.",
            confirm_remove_missionary: "Remover este missionário dos planos de viagem?",
            confirm_delete_all: "Apagar TODAS as viagens de missionários? Isto irá limpar os grupos guardados.",
            confirm_clear_local: "Limpar armazenamento local? Isto irá apagar todas as viagens e definições guardadas.",
            transport_bus: "Ônibus",
            transport_plane: "Avião",
            transport_chapa: "Chapa",
            transport_taxi: "Txopela/Táxi",
            transport_ride: "Boleia",
            choose_option: "Escolha...",
            other_option: "Outro..."
        }
    };

    function setLanguage(lang) {
        state.lang = lang;
        document.querySelectorAll('[data-translate]').forEach(el => {
            const key = el.getAttribute('data-translate');
            if (translations[lang] && translations[lang][key]) {
                el.textContent = translations[lang][key];
            }
        });
        document.querySelectorAll('.lang-select').forEach(sel => {
            sel.value = lang;
        });
        populateTransportDropdowns();
        renderGroups();
    }
    
    function populateTransportDropdowns() {
        const lang = state.lang || 'pt';
        const transportOptions = `
            <option value="Bus">${translations[lang].transport_bus}</option>
            <option value="Plane">${translations[lang].transport_plane}</option>
            <option value="Chapa">${translations[lang].transport_chapa}</option>
            <option value="Txopela/Taxi">${translations[lang].transport_taxi}</option>
            <option value="Ride">${translations[lang].transport_ride}</option>`;
        
        document.getElementById('add-transport').innerHTML = transportOptions;
        document.getElementById('edit-transport').innerHTML = transportOptions;
    }

    // -- State Management
    function loadFromLS() { try { return JSON.parse(localStorage.getItem(LS_KEY)); } catch(e){return null} }
    function saveToLS() { localStorage.setItem(LS_KEY, JSON.stringify(state)); }
    function loadState(){
        renderExceptions();
        renderGroups();
        setLanguage(state.lang || 'pt');
        const uploadSection = document.getElementById('upload-section');
        const btnGroup = document.querySelector('.btn-group');
        if (Object.keys(state.groups || {}).length > 0) {
            if(uploadSection) uploadSection.style.display = 'none';
            if(btnGroup) btnGroup.style.display = 'flex';
        } else {
            if(uploadSection) uploadSection.style.display = 'block';
            if(btnGroup) btnGroup.style.display = 'none';
        }
    }

    // -- Helpers
    function getLastName(fullName) { if (!fullName) return ''; return fullName.split(',')[0].trim(); }
    function normalizeZoneName(name){ if(!name) return ''; name = name.replace(/ZONA/i,'').trim(); return name.charAt(0).toUpperCase()+name.slice(1).toLowerCase(); }
    function autoResizeTextarea(element) {
        if (!element) return;
        element.style.height = 'auto';
        element.style.height = (element.scrollHeight) + 'px';
    }
    function determineCity(loc) {
        if (loc.area && state.exceptions[loc.area]) return state.exceptions[loc.area].city;
        if (loc.district && state.exceptions[loc.district]) return state.exceptions[loc.district].city;
        if (loc.zone && state.exceptions[loc.zone]) return state.exceptions[loc.zone].city;
        return normalizeZoneName(loc.zone || loc.district || loc.area);
    }

    // -- File Processing
    document.getElementById('btn-process').addEventListener('click', async ()=>{
      const fOld = document.getElementById('file-old').files[0];
      const fNew = document.getElementById('file-new').files[0];
      if(!fOld || !fNew){ showToast(translations[state.lang].toast_select_files, 'error'); return; }
      fileOldRows = await readFileRows(fOld);
      fileNewRows = await readFileRows(fNew);
      showMappingModal(fileOldRows[0] || fileNewRows[0]);
    });

    async function readFileRows(file){ const data = await file.arrayBuffer(); const wb = XLSX.read(data); const first = wb.SheetNames[0]; const sheet = wb.Sheets[first]; return XLSX.utils.sheet_to_json(sheet, {defval: ''}); }

    function showMappingModal(sampleRow){
      const container = document.getElementById('mapping-forms'); container.innerHTML = '';
      const keys = Object.keys(sampleRow || {});
      const fields = [ {id:'name', label:'Name'}, {id:'type', label:'Type (Elder/Sister)'}, {id:'area', label:'Area/Neighborhood'}, {id:'district', label:'District'}, {id:'zone', label:'Zone'} ];
      fields.forEach(f=>{
        const div = document.createElement('div');
        div.className = 'form-control';
        div.innerHTML = `<div class="label"><span class="label-text">${f.label}</span></div>
                         <select id="map-${f.id}" class="select select-bordered">
                            <option value="">-- Select column --</option>
                            ${keys.map(k => `<option value="${k}">${k}</option>`).join('')}
                         </select>`;
        container.appendChild(div);
      });
      modal_map.showModal();
    }

    document.getElementById('btn-map-apply').addEventListener('click', ()=>{
      ['name','type','area', 'district', 'zone'].forEach(f=>mapping[f]=document.getElementById('map-'+f).value || null);
      prepareExceptionsAssignment();
    });

    function prepareExceptionsAssignment(){
      const uniqueZones = new Set(); const uniqueDistricts = new Set(); const uniqueAreas = new Set();
      [fileOldRows,fileNewRows].forEach(rows=>{ (rows||[]).forEach(r=>{
        const z = (mapping.zone ? r[mapping.zone] : '').toString().trim();
        const d = (mapping.district ? r[mapping.district] : '').toString().trim();
        const a = (mapping.area ? r[mapping.area] : '').toString().trim();
        if(z) uniqueZones.add(z); if(d) uniqueDistricts.add(d); if(a) uniqueAreas.add(a);
      }); });
      const container = document.getElementById('exceptions-assign'); container.innerHTML='';
      const createSection = (title, list) => {
        if (list.size === 0) return;
        const titleEl = document.createElement('h3'); titleEl.className = 'font-bold text-lg'; titleEl.textContent = title; container.appendChild(titleEl);
        Array.from(list).sort((x,y)=>x.localeCompare(y)).forEach(val=>{
          const row = document.createElement('div'); row.className='grid grid-cols-12 gap-4 items-center';
          const existingCity = state.exceptions[val]?.city || '';
          row.innerHTML = `<div class="col-span-5"><input value="${val}" readonly class="input input-bordered w-full" /></div><div class="col-span-5"><input class="ex-city input input-bordered w-full" data-key="${val}" value="${existingCity}" placeholder="e.g., Beira" /></div><div class="col-span-2"><label class="cursor-pointer label justify-start gap-2"><input type="checkbox" class="ex-apply checkbox" data-key="${val}" ${existingCity ? 'checked' : ''} /><span>Apply</span></label></div>`;
          container.appendChild(row);
        });
        container.appendChild(document.createElement('div')).className = 'divider';
      };
      createSection('Area Overrides', uniqueAreas);
      createSection('District Overrides', uniqueDistricts);
      createSection('Zone Overrides', uniqueZones);
      modal_exceptions.showModal();
    }

    document.getElementById('btn-exceptions-apply').addEventListener('click', ()=>{
      document.querySelectorAll('.ex-apply').forEach(chk => {
          const key = chk.dataset.key; const cityInput = document.querySelector(`.ex-city[data-key="${key}"]`); const city = cityInput.value.trim();
          if (chk.checked && city) { state.exceptions[key] = { city: city }; } else { if (state.exceptions[key] && !defaults.exceptions[key]) { delete state.exceptions[key]; } }
      });
      state.exceptions = Object.assign({}, defaults.exceptions, state.exceptions);
      saveToLS();
      prepareAndShowTransportModal();
    });
    
    function prepareAndShowTransportModal() {
        const oldIdx = {};
        (fileOldRows||[]).forEach(r=>{ const nameVal = mapping.name ? (r[mapping.name]||'') : ''; const key = nameVal.toString().trim().toLowerCase(); if(key) oldIdx[key]=r; });
        
        pendingMissionaries = [];
        (fileNewRows||[]).forEach(r=>{
            const nameVal = (mapping.name ? r[mapping.name] : '').toString().trim();
            const key = nameVal.toLowerCase();
            if(!key) return;
            const old = oldIdx[key];
            
            const rawType = (r[mapping.type]||'').toString().trim();
            const finalType = /^(elder|sister)$/i.test(rawType) ? rawType : '';
            
            const newLoc = {
                zone: (mapping.zone ? r[mapping.zone] : '').toString(),
                district: (mapping.district ? r[mapping.district] : '').toString(),
                area: (mapping.area ? r[mapping.area] : '').toString()
            };

            if (old) {
                const oldLoc = {
                    zone: (mapping.zone ? old[mapping.zone] : '').toString(),
                    district: (mapping.district ? old[mapping.district] : '').toString(),
                    area: (mapping.area ? old[mapping.area] : '').toString()
                };
                if (oldLoc.zone !== newLoc.zone || oldLoc.district !== newLoc.district || oldLoc.area !== newLoc.area) {
                    const originCity = determineCity(oldLoc);
                    const destinationCity = determineCity(newLoc);
                    pendingMissionaries.push({ id: key, name: nameVal, type: finalType, originCity, originArea: oldLoc.area, originDistrict: oldLoc.district, originZone: oldLoc.zone, destinationCity, destinationArea: newLoc.area, destinationDistrict: newLoc.district, destinationZone: newLoc.zone, isNew: false, date: '', tbd: false, time: '', instructions:'', leader:false });
                }
            } else {
                const destinationCity = determineCity(newLoc);
                pendingMissionaries.push({ id: key, name: nameVal, type: finalType, originCity: 'Beira', originArea: '', originDistrict: '', originZone: '', destinationCity, destinationArea: newLoc.area, destinationDistrict: newLoc.district, destinationZone: newLoc.zone, isNew: true, date: '', tbd: false, time: '', instructions:'', leader:false });
            }
        });

        const uniqueRoutes = new Set();
        pendingMissionaries.forEach(m => { uniqueRoutes.add(`${m.originCity} -> ${m.destinationCity}`); });

        const container = document.getElementById('transport-defaults-list');
        container.innerHTML = '';
        const lang = state.lang || 'pt';
        const T = translations[lang];
        const transportOptions = `<option value="Bus">${T.transport_bus}</option><option value="Plane">${T.transport_plane}</option><option value="Chapa">${T.transport_chapa}</option><option value="Txopela/Taxi">${T.transport_taxi}</option><option value="Ride">${T.transport_ride}</option>`;

        Array.from(uniqueRoutes).sort().forEach(route => {
            const [origin, destination] = route.split(' -> ');
            const defaultTransport = defaultTransportForPair(origin, destination);
            const row = document.createElement('div');
            row.className = 'grid grid-cols-2 gap-4 items-center';
            row.innerHTML = `<h6>${route}</h6><select class="select select-bordered transport-default-select" data-route="${route}">${transportOptions}</select>`;
            container.appendChild(row);
            row.querySelector('select').value = defaultTransport;
        });

        modal_transport_defaults.showModal();
    }

    document.getElementById('btn-transport-apply').addEventListener('click', () => {
        const transportDefaults = {};
        document.querySelectorAll('.transport-default-select').forEach(sel => {
            transportDefaults[sel.dataset.route] = sel.value;
        });

        pendingMissionaries.forEach(m => {
            const routeKey = `${m.originCity} -> ${m.destinationCity}`;
            m.transport = transportDefaults[routeKey] || defaultTransportForPair(m.originCity, m.destinationCity);
        });

        state.groups = {};
        pendingMissionaries.forEach(m => {
            const key = `${m.originCity} -> ${m.destinationCity}`;
            if (!state.groups[key]) state.groups[key] = [];
            state.groups[key].push(m);
        });

        saveToLS();
        showToast(translations[state.lang].toast_processed.replace('{count}', pendingMissionaries.length));
        location.reload();
    });

    function defaultTransportForPair(from, to){
      const f = (from||'').toLowerCase(), t = (to||'').toLowerCase();
      if((f === 'nampula' && t === 'quelimane') || (t === 'nampula' && f === 'quelimane')) return 'Bus';
      if (f === 'nampula' || t === 'nampula') return 'Plane';
      const main = ['tete','chimoio','beira'];
      if(main.includes(f) && main.includes(t) && f !== t) return 'Bus';
      if(f === t){ if(f==='beira') return 'Ride'; return 'Txopela/Taxi'; }
      return 'Bus';
    }

    // -- UI Rendering
    function renderGroups(){
      const container = document.getElementById('groups'); container.innerHTML = ''; const lang = state.lang || 'pt'; const T = translations[lang];
      for(const key of Object.keys(state.groups||{})){
        const card = document.createElement('div'); card.className='card bg-base-100 shadow-xl';
        const content = document.createElement('div'); content.className='card-body'; content.innerHTML = `<h2 class="card-title">${key}</h2>`;
        const tableContainer = document.createElement('div'); tableContainer.className = 'overflow-x-auto';
        const table = document.createElement('table'); table.className='table table-sm';
        table.innerHTML = `
          <thead>
            <tr class="bulk-edit-row bg-base-200">
              <th colspan="4">${T.bulk_edit_title}</th>
              <th><select class="select select-sm select-bordered w-full bulk-transport-select" title="${T.bulk_edit_transport_placeholder}"><option selected disabled>${T.bulk_edit_transport_placeholder}</option><option value="Bus">${T.transport_bus}</option><option value="Plane">${T.transport_plane}</option><option value="Chapa">${T.transport_chapa}</option><option value="Txopela/Taxi">${T.transport_taxi}</option><option value="Ride">${T.transport_ride}</option></select></th>
              <th><input type="date" class="input input-sm input-bordered w-full bulk-date-input"></th><th><input type="time" class="input input-sm input-bordered w-full bulk-time-input"></th><th><textarea class="textarea textarea-bordered w-full bulk-instr-input" placeholder="${T.bulk_edit_instructions_placeholder}"></textarea></th><th class="actions-header" colspan="3"></th>
            </tr>
            <tr><th>${T.table_header_type}</th><th>${T.table_header_name}</th><th>${T.table_header_origin_area}</th><th>${T.table_header_dest_area}</th><th>${T.table_header_transport}</th><th>${T.table_header_date}</th><th>${T.table_header_time}</th><th>${T.table_header_instructions}</th><th>${T.table_header_new}</th><th>${T.table_header_leader}</th><th class="actions-header">${T.table_header_actions}</th></tr>
          </thead>`;
        const tbody = document.createElement('tbody');
        const group = state.groups[key];
        const sortedGroup = [...group].sort((a, b) => (a.isNew ? 1 : -1) - (b.isNew ? 1 : -1));

        sortedGroup.forEach(m =>{
          const tr = document.createElement('tr');
          tr.dataset.id = m.id;

          const typeIsEditable = !(m.type === 'Elder' || m.type === 'Sister');
          const typeSelectHTML = `<select class="type-select-editable select select-bordered select-xs w-28"><option value="" ${!m.type ? 'selected' : ''}>${T.choose_option}</option><option>Elder</option><option>Sister</option></select>`;
          const typeCellHTML = `
            <td>
                <span class="pdf-type-wrap">${m.type}</span>
                ${typeIsEditable ? typeSelectHTML : `<span>${m.type}</span>`}
            </td>`;

          tr.innerHTML = `${typeCellHTML}<td>${getLastName(m.name)}</td><td>${m.originArea || ''}</td><td>${m.destinationArea}</td>
            <td><select class="transport-select select select-bordered select-xs"><option value="Bus">${T.transport_bus}</option><option value="Plane">${T.transport_plane}</option><option value="Chapa">${T.transport_chapa}</option><option value="Txopela/Taxi">${T.transport_taxi}</option><option value="Ride">${T.transport_ride}</option></select></td>
            <td><input type="date" class="date-input input input-bordered input-xs" value="${m.date}"><div class="tbd-wrapper mt-1"><label class="cursor-pointer label justify-start gap-2"><input type="checkbox" class="tbd-checkbox checkbox checkbox-xs" ${m.tbd? 'checked':''}/><span>${T.tbd}</span></label></div></td><td><input type="time" class="time-input input input-bordered input-xs" value="${m.time}"></td>
            <td><textarea class="instr-input textarea textarea-bordered w-full">${m.instructions || ''}</textarea><div class="pdf-instr-wrap">${m.instructions || ''}</div></td>
            <td class="new-status-cell text-center">${m.isNew ? '<input type="checkbox" checked="checked" disabled="disabled" class="checkbox checkbox-xs" />' : ''}</td>
            <td class="text-center"><input type="checkbox" class="leader-checkbox checkbox checkbox-xs" ${m.leader ? 'checked':''}></td>
            <td class="actions-cell"><div class="action-buttons"><button class="btn btn-xs btn-info edit-btn"><i class="fa fa-pencil"></i></button><button class="btn btn-xs btn-error remove-btn"><i class="fa fa-trash"></i></button></div></td>`;
          tbody.appendChild(tr);

          const dateInput = tr.querySelector('.date-input');
          const tbdCheckbox = tr.querySelector('.tbd-checkbox');
          const instrTextarea = tr.querySelector('.instr-input');
          
          const toggleDateVisibility = () => { dateInput.style.display = tbdCheckbox.checked ? 'none' : 'block'; };
          
          toggleDateVisibility();
          tbdCheckbox.addEventListener('change', toggleDateVisibility);

          instrTextarea.addEventListener('input', () => autoResizeTextarea(instrTextarea));
          setTimeout(() => autoResizeTextarea(instrTextarea), 0);

          tr.querySelector('.transport-select').value = m.transport;
          
          const updateItem = (item, trElement) => {
              item.transport = trElement.querySelector('.transport-select').value;
              item.date = trElement.querySelector('.date-input').value;
              item.tbd = trElement.querySelector('.tbd-checkbox').checked;
              item.time = trElement.querySelector('.time-input').value;
              item.instructions = trElement.querySelector('.instr-input').value;
              item.leader = trElement.querySelector('.leader-checkbox').checked;
              
              const typeSelect = trElement.querySelector('.type-select-editable');
              if (typeSelect) { item.type = typeSelect.value; }
              saveToLS();
          };

          tr.querySelectorAll('input, select, textarea').forEach(el => {
              el.addEventListener('change', (e) => {
                  const trElement = e.target.closest('tr');
                  const missionaryId = trElement.dataset.id;
                  const item = group.find(miss => miss.id === missionaryId);
                  if (item) { updateItem(item, trElement); }
              });
          });

          tr.querySelector('.remove-btn').addEventListener('click', (e)=>{ 
            if(confirm(T.confirm_remove_missionary)){
                const missionaryId = e.currentTarget.closest('tr').dataset.id;
                const indexToRemove = group.findIndex(miss => miss.id === missionaryId);
                if(indexToRemove > -1) {
                    group.splice(indexToRemove, 1);
                    if(group.length===0) delete state.groups[key];
                    saveToLS();
                    renderGroups();
                }
            }
          });

          tr.querySelector('.edit-btn').addEventListener('click', (e) => {
            const missionaryId = e.currentTarget.closest('tr').dataset.id;
            const indexToEdit = group.findIndex(miss => miss.id === missionaryId);
            if(indexToEdit > -1) {
                openEditModal(key, indexToEdit);
            }
          });
        });
        tableContainer.appendChild(table);
        content.appendChild(tableContainer);
        card.appendChild(content);
        const bulkUpdate = (field, value) => { if(!value && field !== 'instructions') return; state.groups[key].forEach(m => { m[field] = value; }); saveToLS(); renderGroups(); showToast(T.toast_updated.replace('{field}', field)); };
        
        const bulkInstrTextarea = card.querySelector('.bulk-instr-input');
        bulkInstrTextarea.addEventListener('input', () => autoResizeTextarea(bulkInstrTextarea));
        
        card.querySelector('.bulk-transport-select').addEventListener('change', (e) => bulkUpdate('transport', e.target.value));
        card.querySelector('.bulk-date-input').addEventListener('change', (e) => bulkUpdate('date', e.target.value));
        card.querySelector('.bulk-time-input').addEventListener('change', (e) => bulkUpdate('time', e.target.value));
        bulkInstrTextarea.addEventListener('change', (e) => bulkUpdate('instructions', e.target.value));
        container.appendChild(card);
      }
      populateCityDropdowns();
    }
    
    function populateCityDropdowns() {
        const cities = new Set();
        Object.values(state.groups || {}).flat().forEach(m => {
            cities.add(m.originCity);
            cities.add(m.destinationCity);
        });
        const sortedCities = Array.from(cities).sort();
        const lang = state.lang || 'pt';
        
        const selects = document.querySelectorAll('#add-origin-select, #add-dest-select, #edit-origin-select, #edit-dest-select');
        
        selects.forEach(select => {
            select.innerHTML = `<option value="" disabled selected>${translations[lang].choose_option}</option>`;
            sortedCities.forEach(city => {
                select.innerHTML += `<option value="${city}">${city}</option>`;
            });
            select.innerHTML += `<option value="other">${translations[lang].other_option}</option>`;
        });
    }

    function openEditModal(groupKey, index) {
        const missionary = state.groups[groupKey][index];
        
        document.getElementById('edit-original-group-key').value = groupKey;
        document.getElementById('edit-missionary-id').value = missionary.id;
        document.getElementById('edit-name').value = missionary.name;
        document.getElementById('edit-type').value = missionary.type;
        
        const originSelect = document.getElementById('edit-origin-select');
        const originOther = document.getElementById('edit-origin-other');
        if (Array.from(originSelect.options).some(opt => opt.value === missionary.originCity)) {
            originSelect.value = missionary.originCity;
            originOther.style.display = 'none';
        } else {
            originSelect.value = 'other';
            originOther.value = missionary.originCity;
            originOther.style.display = 'block';
        }

        const destSelect = document.getElementById('edit-dest-select');
        const destOther = document.getElementById('edit-dest-other');
        if (Array.from(destSelect.options).some(opt => opt.value === missionary.destinationCity)) {
            destSelect.value = missionary.destinationCity;
            destOther.style.display = 'none';
        } else {
            destSelect.value = 'other';
            destOther.value = missionary.destinationCity;
            destOther.style.display = 'block';
        }
        
        document.getElementById('edit-originarea').value = missionary.originArea || '';
        document.getElementById('edit-destarea').value = missionary.destinationArea;
        document.getElementById('edit-transport').value = missionary.transport;
        document.getElementById('edit-date').value = missionary.date;
        document.getElementById('edit-tbd').checked = missionary.tbd;
        document.getElementById('edit-time').value = missionary.time;
        document.getElementById('edit-instructions').value = missionary.instructions;
        document.getElementById('edit-leader').checked = missionary.leader;
        
        document.querySelector('.edit-date-wrapper').style.display = missionary.tbd ? 'none' : 'block';

        modal_edit.showModal();
    }

    // -- Event Listeners
    document.getElementById('add-tbd').addEventListener('change', (e) => { document.querySelector('.add-date-wrapper').style.display = e.target.checked ? 'none' : 'block'; });
    document.getElementById('edit-tbd').addEventListener('change', (e) => { document.querySelector('.edit-date-wrapper').style.display = e.target.checked ? 'none' : 'block'; });

    document.getElementById('add-origin-select').addEventListener('change', (e) => { document.getElementById('add-origin-other').style.display = e.target.value === 'other' ? 'block' : 'none'; });
    document.getElementById('add-dest-select').addEventListener('change', (e) => { document.getElementById('add-dest-other').style.display = e.target.value === 'other' ? 'block' : 'none'; });
    document.getElementById('edit-origin-select').addEventListener('change', (e) => { document.getElementById('edit-origin-other').style.display = e.target.value === 'other' ? 'block' : 'none'; });
    document.getElementById('edit-dest-select').addEventListener('change', (e) => { document.getElementById('edit-dest-other').style.display = e.target.value === 'other' ? 'block' : 'none'; });

    document.getElementById('btn-add-save').addEventListener('click', ()=>{
      const originSelect = document.getElementById('add-origin-select');
      const destSelect = document.getElementById('add-dest-select');
      const originCity = originSelect.value === 'other' ? document.getElementById('add-origin-other').value : originSelect.value;
      const destCity = destSelect.value === 'other' ? document.getElementById('add-dest-other').value : destSelect.value;

      const m = {
        id: document.getElementById('add-name').value.trim().toLowerCase(), type: document.getElementById('add-type').value, name: document.getElementById('add-name').value.trim(), originCity: normalizeZoneName(originCity), destinationCity: normalizeZoneName(destCity),
        originArea: document.getElementById('add-originarea').value, destinationArea: document.getElementById('add-destarea').value, transport: document.getElementById('add-transport').value, date: document.getElementById('add-date').value, tbd: document.getElementById('add-tbd').checked, time: document.getElementById('add-time').value, instructions: document.getElementById('add-instructions').value, leader: document.getElementById('add-leader').checked, isNew: document.getElementById('add-new').checked
      };
      const key = `${m.originCity} -> ${m.destinationCity}`; if(!state.groups[key]) state.groups[key]=[]; state.groups[key].push(m);
      saveToLS();
      showToast(translations[state.lang].toast_added);
      location.reload();
    });
    
    document.getElementById('btn-edit-save').addEventListener('click', () => {
        const originalGroupKey = document.getElementById('edit-original-group-key').value;
        const missionaryId = document.getElementById('edit-missionary-id').value;
        const index = state.groups[originalGroupKey].findIndex(m => m.id === missionaryId);
        
        if (index === -1) return;

        const originalMissionary = state.groups[originalGroupKey][index];
        
        const originSelect = document.getElementById('edit-origin-select');
        const destSelect = document.getElementById('edit-dest-select');
        const originCity = originSelect.value === 'other' ? document.getElementById('edit-origin-other').value : originSelect.value;
        const destCity = destSelect.value === 'other' ? document.getElementById('edit-dest-other').value : destSelect.value;

        const missionary = { ...originalMissionary,
            id: document.getElementById('edit-name').value.trim().toLowerCase(), name: document.getElementById('edit-name').value.trim(), type: document.getElementById('edit-type').value, originCity: normalizeZoneName(originCity), destinationCity: normalizeZoneName(destCity),
            originArea: document.getElementById('edit-originarea').value, destinationArea: document.getElementById('edit-destarea').value, transport: document.getElementById('edit-transport').value, date: document.getElementById('edit-date').value, tbd: document.getElementById('edit-tbd').checked, time: document.getElementById('edit-time').value, instructions: document.getElementById('edit-instructions').value, leader: document.getElementById('edit-leader').checked
        };

        state.groups[originalGroupKey].splice(index, 1);
        if (state.groups[originalGroupKey].length === 0) {
            delete state.groups[originalGroupKey];
        }

        const newGroupKey = `${missionary.originCity} -> ${missionary.destinationCity}`;
        if (!state.groups[newGroupKey]) { state.groups[newGroupKey] = []; }
        state.groups[newGroupKey].push(missionary);
        saveToLS();
        location.reload();
    });
    
    document.getElementById('btn-save-exception').addEventListener('click', () => {
      const name = document.getElementById('ex-add-name').value.trim(); const city = document.getElementById('ex-add-city').value.trim(); if (!name || !city) return; if (!state.exceptions) state.exceptions = {}; state.exceptions[name] = { city: city };
      saveToLS(); renderExceptions(); document.getElementById('ex-add-name').value = ''; document.getElementById('ex-add-city').value = ''; M.updateTextFields();
    });

    function renderExceptions(){ const el = document.getElementById('exceptions-list'); el.innerHTML=''; for(const k of Object.keys(state.exceptions||{})){ const row = document.createElement('div'); row.className='grid grid-cols-3 gap-4 items-center'; row.innerHTML = `<div>${k}</div><div>${state.exceptions[k].city || ''}</div><div><button data-key="${k}" class="btn btn-xs btn-error btn-ex-remove">Remove</button></div>`; el.appendChild(row); row.querySelector('.btn-ex-remove').addEventListener('click', (e)=>{ delete state.exceptions[e.currentTarget.dataset.key]; saveToLS(); renderExceptions(); }); } }
    
    document.getElementById('btn-clear-local').addEventListener('click', ()=>{ if(confirm(translations[state.lang].confirm_clear_local)){ localStorage.removeItem(LS_KEY); location.reload(); } });
    
    document.querySelectorAll('.lang-select').forEach(sel => {
        sel.addEventListener('change', (e)=>{
          state.lang = e.target.value;
          saveToLS();
          location.reload();
        });
    });
    
    // -- Export and Update Functions
    document.getElementById('btn-export-pdf').addEventListener('click', () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'l', unit: 'mm', format: 'a4' });
        const lang = state.lang || 'pt';
        const T = translations[lang];

        const groups = Object.keys(state.groups);
        if (groups.length === 0) return;

        showToast(T.toast_pdf_generating);

        let finalY = 15;

        groups.forEach((groupKey, index) => {
            if (index > 0) {
                doc.addPage();
                finalY = 15;
            }

            const group = state.groups[groupKey];
            const sortedGroup = [...group].sort((a, b) => (a.isNew ? 1 : -1) - (b.isNew ? 1 : -1));

            const head = [[
                T.table_header_type, T.table_header_name, T.table_header_origin_area, T.table_header_dest_area,
                T.table_header_transport, T.table_header_date, T.table_header_time,
                T.table_header_instructions, T.table_header_new, T.table_header_leader
            ]];

            const body = sortedGroup.map(m => {
                const transportText = m.transport ? (translations[lang][`transport_${m.transport.toLowerCase().replace('/','_')}`] || m.transport) : '';
                return [
                    m.type || '',
                    getLastName(m.name),
                    m.originArea || '',
                    m.destinationArea,
                    transportText,
                    m.tbd ? T.tbd : m.date,
                    m.time,
                    m.instructions || '',
                    m.isNew ? '✔️' : '',
                    m.leader ? '⭐' : ''
                ];
            });

            doc.setFontSize(16);
            doc.text(groupKey, 14, finalY);
            finalY += 8;

            doc.autoTable({
                head: head,
                body: body,
                startY: finalY,
                theme: 'striped',
                headStyles: { fillColor: [34, 150, 136] },
                columnStyles: {
                    0: { cellWidth: 18 }, 1: { cellWidth: 30 }, 2: { cellWidth: 30 }, 
                    3: { cellWidth: 30 }, 4: { cellWidth: 25 }, 5: { cellWidth: 22 }, 
                    6: { cellWidth: 17 }, 7: { cellWidth: 'auto' }, 8: { cellWidth: 12, halign: 'center' }, 
                    9: { cellWidth: 15, halign: 'center' },
                },
                didDrawPage: (data) => {
                    finalY = data.cursor.y + 15;
                }
            });
             finalY = doc.previousAutoTable.finalY + 15;
        });

        doc.save('transfer_logistics.pdf');
        showToast(T.toast_pdf_generated);
    });


    document.getElementById('btn-export-csv').addEventListener('click', () => {
        const lang = state.lang || 'pt';
        const T = translations[lang];
        const delimiter = ';';
        const headers = ["Type", "Name", "Origin City", "Origin District", "Origin Zone", "Origin Area", "Destination City", "Destination District", "Destination Zone", "Destination Area", "Transportation", "Date", "Time", "Instructions", "New", "Leader"];
        let csvContent = "data:text/csv;charset=utf-8," + headers.join(delimiter) + "\n";
        const allMissionaries = Object.values(state.groups || {}).flat();
        
        allMissionaries.forEach(m => {
            const transportText = m.transport ? (T[`transport_${m.transport.toLowerCase().replace('/','_')}`] || m.transport) : '';
            const leaderText = m.leader ? 'Yes' : 'No';
            const newText = m.isNew ? 'Yes' : 'No';
            const sanitize = (str) => `"${(str || '').replace(/"/g, '""')}"`;
            
            const row = [ m.type, sanitize(m.name), m.originCity, sanitize(m.originDistrict), sanitize(m.originZone), sanitize(m.originArea), m.destinationCity, sanitize(m.destinationDistrict), sanitize(m.destinationZone), sanitize(m.destinationArea), transportText, m.date, m.time, sanitize(m.instructions), newText, leaderText];
            csvContent += row.join(delimiter) + "\n";
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "travel_plans.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    });

    document.getElementById('btn-restore').addEventListener('click', async () => {
        const file = document.getElementById('file-restore').files[0];
        if (!file) {
            showToast(translations[state.lang].toast_restore_file, 'error');
            return;
        }

        const data = await file.text();
        const rows = data.split('\n').slice(1);
        const restoredMissionaries = [];
        
        const unquote = (str) => str ? (str.startsWith('"') && str.endsWith('"') ? str.slice(1, -1).replace(/""/g, '"') : str) : '';

        for (const row of rows) {
            if (!row.trim()) continue;
            const cols = row.split(';').map(unquote);
            
            const transportValEN = Object.keys(translations.en).find(key => translations.en[key] === cols[10]);
            const transportValPT = Object.keys(translations.pt).find(key => translations.pt[key] === cols[10]);
            const transportKey = (transportValEN || transportValPT || '').replace('transport_', '');

            const missionary = {
                type: cols[0], name: cols[1], originCity: cols[2], originDistrict: cols[3], originZone: cols[4], originArea: cols[5],
                destinationCity: cols[6], destinationDistrict: cols[7], destinationZone: cols[8], destinationArea: cols[9],
                transport: transportKey, date: cols[11], time: cols[12], instructions: cols[13],
                isNew: cols[14]?.toLowerCase() === 'yes', leader: cols[15]?.toLowerCase() === 'yes',
                id: (cols[1] || '').toLowerCase(),
                tbd: cols[11] === translations.en.tbd || cols[11] === translations.pt.tbd
            };
            restoredMissionaries.push(missionary);
        }

        state.groups = {};
        restoredMissionaries.forEach(m => {
            const key = `${m.originCity} -> ${m.destinationCity}`;
            if (!state.groups[key]) state.groups[key] = [];
            state.groups[key].push(m);
        });

        saveToLS();
        showToast(translations[state.lang].toast_restored);
        location.reload();
    });

    document.getElementById('btn-update-origins').addEventListener('click', () => {
        document.getElementById('file-update-origin').click();
    });

    document.getElementById('file-update-origin').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const rows = await readFileRows(file);
        const container = document.getElementById('mapping-forms-update');
        container.innerHTML = '';
        const keys = Object.keys(rows[0] || {});
        const fields = [{ id: 'name', label: 'Missionary Name' }, { id: 'originArea', label: 'Origin Area' }];

        fields.forEach(f => {
            const div = document.createElement('div');
            div.className = "form-control";
            div.innerHTML = `<div class="label"><span class="label-text">${f.label}</span></div>
                             <select id="map-update-${f.id}" class="select select-bordered">
                                <option value="">-- Select column --</option>
                                ${keys.map(k => `<option value="${k}">${k}</option>`).join('')}
                             </select>`;
            container.appendChild(div);
        });

        modal_map_update.showModal();

        document.getElementById('btn-map-update-apply').onclick = () => {
            const nameCol = document.getElementById('map-update-name').value;
            const areaCol = document.getElementById('map-update-originArea').value;
            if (!nameCol || !areaCol) return;

            const originAreaMap = {};
            rows.forEach(row => {
                const name = (row[nameCol] || '').toString().trim().toLowerCase();
                if (name) {
                    originAreaMap[name] = (row[areaCol] || '').toString().trim();
                }
            });

            Object.values(state.groups).flat().forEach(missionary => {
                if (originAreaMap[missionary.id]) {
                    missionary.originArea = originAreaMap[missionary.id];
                }
            });

            saveToLS();
            showToast(translations[state.lang].toast_origins_updated);
            location.reload();
        };
        e.target.value = '';
    });

    // -- Initial Load
    document.addEventListener('DOMContentLoaded', ()=>{
        const savedTheme = localStorage.getItem(THEME_KEY) || 'winter';
        applyTheme(savedTheme);
        const ls = loadFromLS(); if(ls){ state=ls; }
        state.exceptions = Object.assign({}, defaults.exceptions, state.exceptions||{});
        saveToLS();
        loadState();
    });
  </script>
</body>
</html>
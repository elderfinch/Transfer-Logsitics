<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Transfer Logistics</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    body { padding: 16px; }
    .container { width: 95%; max-width: initial; }
    .chip-leader { background: #ffd54f; }
    .group-card { margin-bottom: 18px; }
    .small-input { width:120px }
    .time-input { width:140px }
    .bulk-instr-input::placeholder { color: #9e9e9e; }
  </style>
</head>
<body>
  <nav>
    <div class="nav-wrapper teal">
      <a href="#" class="brand-logo center">Transfer Logistics</a>
      <ul id="nav-mobile" class="left">
        <li><a id="btn-settings" href="#modal-settings" class="modal-trigger"><i class="fa fa-cog"></i></a></li>
      </ul>
    </div>
  </nav>

  <div class="container">
    <div class="section">
      <h5>Upload transferboards</h5>
      <div class="row">
        <div class="col s12 m6">
          <label>Old transferboard (from)</label>
          <input id="file-old" type="file" accept=".xlsx,.xls,.csv" />
        </div>
        <div class="col s12 m6">
          <label>New transferboard (to)</label>
          <input id="file-new" type="file" accept=".xlsx,.xls,.csv" />
        </div>
      </div>
      <a id="btn-process" class="btn">Process upload</a>
      <a id="btn-clear-local" class="btn red">Clear All Saved Travel</a>
    </div>

    <div class="section">
      <h5>Groups</h5>
      <div id="groups"></div>
    </div>

    <div class="fixed-action-btn">
      <a class="btn-floating btn-large teal modal-trigger" href="#modal-add"><i class="large material-icons">add</i></a>
    </div>
  </div>

  <div id="modal-add" class="modal">
    <div class="modal-content">
      <h5>Add Missionary</h5>
      <div class="row">
        <div class="input-field col s2">
          <select id="add-type">
            <option value="" disabled selected>Choose...</option>
            <option value="Elder">Elder</option>
            <option value="Sister">Sister</option>
          </select>
          <label>Type</label>
        </div>
        <div class="input-field col s4">
          <input id="add-name">
          <label for="add-name">Name</label>
        </div>
        <div class="input-field col s3">
          <input id="add-origin">
          <label for="add-origin">Origin City</label>
        </div>
        <div class="input-field col s3">
          <input id="add-dest">
          <label for="add-dest">Destination City</label>
        </div>
      </div>
      <div class="row">
        <div class="input-field col s4">
          <input id="add-destarea">
          <label for="add-destarea">Destination Area</label>
        </div>
        <div class="input-field col s4">
          <select id="add-transport">
            <option value="Bus" selected>Bus</option>
            <option value="Plane">Plane</option>
            <option value="Chapa">Chapa</option>
            <option value="Txopela/Taxi">Txopela/Taxi</option>
            <option value="Ride">Ride</option>
          </select>
          <label>Transportation</label>
        </div>
        <div class="input-field col s2">
          <input id="add-date" type="date">
          <label for="add-date">Date</label>
        </div>
        <div class="col s2">
          <label>
            <input type="checkbox" id="add-tbd" />
            <span>TBD</span>
          </label>
        </div>
      </div>
      <div class="row">
        <div class="input-field col s3">
          <input id="add-time" type="time">
          <label for="add-time">Departure Time</label>
        </div>
        <div class="input-field col s5">
          <input id="add-instructions">
          <label for="add-instructions">Travel Instructions</label>
        </div>
        <div class="col s2">
          <label>
            <input type="checkbox" id="add-leader" />
            <span>Travel Leader</span>
          </label>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <a id="btn-add-save" class="modal-close btn">Save</a>
    </div>
  </div>

  <div id="modal-settings" class="modal">
    <div class="modal-content">
      <h5>Settings</h5>
      <div class="row">
        <div class="input-field col s6">
          <select id="lang-select">
            <option value="en">English</option>
            <option value="pt">Português</option>
          </select>
          <label>Language</label>
        </div>
        <div class="col s6">
          <a id="btn-delete-all" class="btn red">Delete All Missionary Travel</a>
        </div>
      </div>
      <h6>Area/District Exceptions</h6>
      <div id="exceptions-list"></div>
      <div class="section">
        <h6>Add New Exception</h6>
        <div class="row">
          <div class="input-field col s5">
            <input id="ex-add-name" type="text">
            <label for="ex-add-name">Area/District/Zone Name</label>
          </div>
          <div class="input-field col s5">
            <input id="ex-add-city" type="text">
            <label for="ex-add-city">Override City</label>
          </div>
          <div class="input-field col s2">
            <a id="btn-save-exception" class="btn">Save</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="modal-map" class="modal">
    <div class="modal-content">
      <h5>Map columns (choose which column in your spreadsheet corresponds to these fields)</h5>
      <p><strong>Note:</strong> There is no ID column — the missionary <em>name</em> will be used as the identifier.</p>
      <div id="mapping-forms"></div>
    </div>
    <div class="modal-footer">
      <a id="btn-map-apply" class="modal-close btn">Apply Mapping</a>
    </div>
  </div>

  <div id="modal-exceptions" class="modal modal-fixed-footer">
    <div class="modal-content">
      <h5>Assign exceptions (areas/districts that map to a different city)</h5>
      <p>For any area or zone below, you can enter a city name to override the default. Check "Apply" to save the exception.</p>
      <div id="exceptions-assign"></div>
    </div>
    <div class="modal-footer">
      <a id="btn-exceptions-apply" class="modal-close btn">Save Exceptions</a>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script>
    // -- Constants & defaults
    const LS_KEY = 'transfer_logistics_data_v1';
    const defaults = {
      exceptions: {
        'Quelimane': { city: 'Quelimane' },
        'Nhamatanda': { city: 'Nhamatanda' },
        'Marromeu': { city: 'Marromeu' },
        'Caia': { city: 'Caia' },
        'ZONA INHAMIZUA': { city: 'Beira' },
        'ZONA MANGA': { city: 'Beira' },
        'ZONA MUNHAVA': { city: 'Beira' }
      }
    };

    // translations
    const T = {
      en: { Bus: 'Bus', Plane: 'Plane', Chapa: 'Chapa', 'Txopela/Taxi': 'Txopela/Taxi', Ride: 'Ride' },
      pt: { Bus: 'Autocarro', Plane: 'Avião', Chapa: 'Chapa', 'Txopela/Taxi': 'Txopela/Taxi', Ride: 'Boleia' }
    };

    // init materialize
    document.addEventListener('DOMContentLoaded', function() { M.AutoInit(); loadState(); });

    // -- State
    let state = loadFromLS() || { groups: {}, exceptions: defaults.exceptions };

    function loadFromLS() { try { return JSON.parse(localStorage.getItem(LS_KEY)); } catch(e){return null} }
    function saveToLS() { localStorage.setItem(LS_KEY, JSON.stringify(state)); }

    function loadState(){ renderExceptions(); renderGroups(); }

    // --- helpers for normalization
    function normalizeZoneName(name){ if(!name) return ''; name = name.replace(/ZONA/i,'').trim(); return name.charAt(0).toUpperCase()+name.slice(1).toLowerCase(); }

    // Apply exceptions mapping: if area/district matches key, use its city override
    function areaToCity(area){ if(!area) return '';
      for(const key of Object.keys(state.exceptions||{})){
        if(key.toLowerCase() === area.toLowerCase()){
          return state.exceptions[key].city || key;
        }
      }
      return normalizeZoneName(area);
    }

    // --- File reading + mapping UI
    let fileOldRows = null; let fileNewRows = null;
    let mapping = { name: null, type: null, area: null, zone: null };

    document.getElementById('btn-process').addEventListener('click', async ()=>{
      const fOld = document.getElementById('file-old').files[0];
      const fNew = document.getElementById('file-new').files[0];
      if(!fOld || !fNew){ M.toast({html:'Please select both files'}); return; }
      fileOldRows = await readFileRows(fOld);
      fileNewRows = await readFileRows(fNew);
      showMappingModal(fileOldRows[0] || fileNewRows[0]);
    });

    async function readFileRows(file){ const data = await file.arrayBuffer(); const wb = XLSX.read(data); const first = wb.SheetNames[0]; const sheet = wb.Sheets[first]; return XLSX.utils.sheet_to_json(sheet, {defval: ''}); }

    function showMappingModal(sampleRow){
      const container = document.getElementById('mapping-forms'); container.innerHTML = '';
      const keys = Object.keys(sampleRow || {});
      const fields = [ {id:'name', label:'Name'}, {id:'type', label:'Type (Elder/Sister)'}, {id:'area', label:'Area/Neighborhood'}, {id:'zone', label:'Zone (this becomes City by default)'} ];
      fields.forEach(f=>{
        const div = document.createElement('div');
        div.style.marginBottom = '20px';
        const h6 = document.createElement('h6');
        h6.textContent = f.label;
        const select = document.createElement('select');
        select.id = 'map-'+f.id;
        select.className = 'browser-default';
        const emptyOpt = document.createElement('option'); emptyOpt.value=''; emptyOpt.text='-- Select column --'; select.appendChild(emptyOpt);
        keys.forEach(k=>{ const opt=document.createElement('option'); opt.value=k; opt.text=k; select.appendChild(opt); });
        div.appendChild(h6);
        div.appendChild(select);
        container.appendChild(div);
      });
      const modal = M.Modal.getInstance(document.getElementById('modal-map'));
      modal.open();
    }

    document.getElementById('btn-map-apply').addEventListener('click', ()=>{
      ['name','type','area','zone'].forEach(f=>mapping[f]=document.getElementById('map-'+f).value || null);
      prepareExceptionsAssignment();
    });

    function prepareExceptionsAssignment(){
      const uniqueZones = new Set();
      const uniqueAreas = new Set();
      [fileOldRows,fileNewRows].forEach(rows=>{ (rows||[]).forEach(r=>{
        const z = mapping.zone ? (r[mapping.zone]||'').toString().trim() : '';
        const a = mapping.area ? (r[mapping.area]||'').toString().trim() : '';
        if(z) uniqueZones.add(z);
        if(a) uniqueAreas.add(a);
      }); });
      const listZones = Array.from(uniqueZones).sort((x,y)=>x.localeCompare(y));
      const listAreas = Array.from(uniqueAreas).sort((x,y)=>x.localeCompare(y));
      const container = document.getElementById('exceptions-assign'); container.innerHTML='';

      const createSection = (title, list) => {
        if (list.length === 0) return;
        const titleEl = document.createElement('h5'); titleEl.textContent = title; container.appendChild(titleEl);
        list.forEach(val=>{
          const row = document.createElement('div'); row.className='row valign-wrapper'; row.style.marginBottom = '0px';
          const existingCity = state.exceptions[val]?.city || '';
          row.innerHTML = `
            <div class="input-field col s5"> <input value="${val}" readonly> <label class="active">Source Name</label></div>
            <div class="input-field col s5"> <input class="ex-city" data-key="${val}" value="${existingCity}" placeholder="e.g., Beira" /> <label class="active">Override City</label></div>
            <div class="col s2"> <label><input type="checkbox" class="ex-apply" data-key="${val}" ${existingCity ? 'checked' : ''} /><span>Apply</span></label></div>
          `;
          container.appendChild(row);
        });
        const divider = document.createElement('div'); divider.className = 'divider'; divider.style.margin = '20px 0'; container.appendChild(divider);
      };
      createSection('Zone Overrides', listZones);
      createSection('Area Overrides', listAreas);
      M.AutoInit();
      const modal = M.Modal.getInstance(document.getElementById('modal-exceptions'));
      modal.open();
    }

    document.getElementById('btn-exceptions-apply').addEventListener('click', ()=>{
      document.querySelectorAll('.ex-apply').forEach(chk => {
          const key = chk.dataset.key;
          const cityInput = document.querySelector(`.ex-city[data-key="${key}"]`);
          const city = cityInput.value.trim();
          if (chk.checked && city) {
              state.exceptions[key] = { city: city };
          } else {
              if (state.exceptions[key]) {
                  delete state.exceptions[key];
              }
          }
      });
      state.exceptions = Object.assign({}, defaults.exceptions, state.exceptions);
      saveToLS();
      renderExceptions();
      processTransfers();
    });

    function processTransfers(){
      const oldIdx = {};
      (fileOldRows||[]).forEach(r=>{
        const nameVal = mapping.name ? (r[mapping.name]||'') : '';
        const key = nameVal.toString().trim().toLowerCase();
        if(key) oldIdx[key]=r;
      });
      const transfers = [];
      (fileNewRows||[]).forEach(r=>{
        const nameVal = mapping.name ? (r[mapping.name]||'') : '';
        const key = nameVal.toString().trim().toLowerCase();
        const old = oldIdx[key];
        if(!old) return;
        const oldZone = mapping.zone ? (old[mapping.zone]||'') : '';
        const newZone = mapping.zone ? (r[mapping.zone]||'') : '';
        const oldArea = mapping.area ? (old[mapping.area]||'') : '';
        const newArea = mapping.area ? (r[mapping.area]||'') : '';
        const oldZoneStr = oldZone.toString();
        const newZoneStr = newZone.toString();
        const oldAreaStr = oldArea.toString();
        const newAreaStr = newArea.toString();
        if(oldZoneStr !== newZoneStr || oldAreaStr !== newAreaStr){
          const originCity = areaToCity(oldZoneStr || oldAreaStr);
          const destinationCity = areaToCity(newZoneStr || newAreaStr);
          const m = {
            id: key,
            type: (r[mapping.type]||'').toString(),
            name: (r[mapping.name]||'').toString(),
            originZone: oldZoneStr,
            destinationZone: newZoneStr,
            originArea: oldAreaStr,
            destinationArea: newAreaStr,
            originCity: originCity || normalizeZoneName(oldZoneStr || oldAreaStr),
            destinationCity: destinationCity || normalizeZoneName(newZoneStr || newAreaStr),
            transport: defaultTransportForPair(originCity || normalizeZoneName(oldZoneStr||oldAreaStr), destinationCity || normalizeZoneName(newZoneStr||newAreaStr)),
            date: '', tbd: false, time: '', instructions:'', leader:false
          };
          transfers.push(m);
        }
      });
      state.groups = {};
      transfers.forEach(m=>{
        const key = `${m.originCity} -> ${m.destinationCity}`;
        if(!state.groups[key]) state.groups[key]=[];
        state.groups[key].push(m);
      });
      saveToLS(); renderGroups();
      M.toast({html: `Processed ${transfers.length} transfers.`});
    }

    function defaultTransportForPair(from, to){
      const f = (from||'').toLowerCase(), t = (to||'').toLowerCase();
      const main = ['tete','chimoio','beira'];
      if(main.includes(f) && main.includes(t) && f !== t) return 'Bus';
      if((f==='quelimane' && t==='nampula') || (f==='nampula' && t==='quelimane')) return 'Bus';
      if((['tete','chimoio','beira'].includes(f) && t==='nampula')) return 'Plane';
      if(f === t){ if(f==='beira') return 'Ride'; return 'Txopela/Taxi'; }
      return 'Bus';
    }

    function renderGroups(){
      const container = document.getElementById('groups'); container.innerHTML = '';
      const lang = document.getElementById('lang-select')?.value || 'en';
      for(const key of Object.keys(state.groups||{})){
        const card = document.createElement('div'); card.className='card group-card';
        const content = document.createElement('div'); content.className='card-content';
        const title = document.createElement('span'); title.className='card-title'; title.textContent = key;
        content.appendChild(title);
        const table = document.createElement('table'); table.className='striped';
        const thead = document.createElement('thead');
        thead.innerHTML = `
          <tr>
            <th colspan="5">Bulk Edit for This Group:</th>
            <th>
              <select class="bulk-transport-select browser-default" title="Set transport for all in this group">
                  <option value="" selected disabled>Set Transport</option>
                  <option value="Bus">${T[lang].Bus}</option>
                  <option value="Plane">${T[lang].Plane}</option>
                  <option value="Chapa">${T[lang].Chapa}</option>
                  <option value="Txopela/Taxi">${T[lang]['Txopela/Taxi']}</option>
                  <option value="Ride">${T[lang].Ride}</option>
              </select>
            </th>
            <th><input type="date" class="bulk-date-input" title="Set date for all in this group"></th>
            <th><input type="time" class="bulk-time-input" title="Set time for all in this group"></th>
            <th><input class="bulk-instr-input" placeholder="Set instructions for all"></th>
            <th colspan="2"></th>
          </tr>
          <tr><th>Type</th><th>Name</th><th>Origin City</th><th>Destination City</th><th>Destination Area</th><th>Transportation</th><th>Date</th><th>Time</th><th>Instructions</th><th>Leader</th><th>Remove</th></tr>`;
        table.appendChild(thead);
        const tbody = document.createElement('tbody');
        state.groups[key].forEach((m, idx)=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><input value="${m.type}" class="type-input" readonly></td>
            <td>${m.name}</td>
            <td>${m.originCity}</td>
            <td>${m.destinationCity}</td>
            <td><input value="${m.destinationArea}" class="destarea-input" readonly></td>
            <td>
              <select class="transport-select browser-default">
                <option value="Bus">${T[lang].Bus}</option>
                <option value="Plane">${T[lang].Plane}</option>
                <option value="Chapa">${T[lang].Chapa}</option>
                <option value="Txopela/Taxi">${T[lang]['Txopela/Taxi']}</option>
                <option value="Ride">${T[lang].Ride}</option>
              </select>
            </td>
            <td><input type="date" class="date-input" value="${m.date}"><p style="margin-top: 5px;"><label><input type="checkbox" class="tbd-checkbox" ${m.tbd? 'checked':''}><span>TBD</span></label></p></td>
            <td><input type="time" class="time-input" value="${m.time}"></td>
            <td><textarea class="instr-input materialize-textarea">${m.instructions || ''}</textarea></td>
            <td><label><input type="checkbox" class="leader-checkbox" ${m.leader ? 'checked':''}><span></span></label></td>
            <td><a class="btn-small red remove-btn"><i class="fa fa-trash"></i></a></td>
          `;
          tbody.appendChild(tr);
          tr.querySelector('.transport-select').value = m.transport;

          tr.querySelectorAll('input, select, textarea').forEach(el=>{
            el.addEventListener('change', ()=>{
              const item = state.groups[key][idx];
              item.transport = tr.querySelector('.transport-select').value;
              item.date = tr.querySelector('.date-input').value;
              item.tbd = tr.querySelector('.tbd-checkbox').checked;
              item.time = tr.querySelector('.time-input').value;
              item.instructions = tr.querySelector('.instr-input').value;
              item.leader = tr.querySelector('.leader-checkbox').checked;
              saveToLS();
            });
          });

          tr.querySelector('.remove-btn').addEventListener('click', ()=>{
            if(confirm('Remove this missionary from travel plans?')){
              state.groups[key].splice(idx,1);
              if(state.groups[key].length===0) delete state.groups[key];
              saveToLS(); renderGroups();
            }
          });
        });
        table.appendChild(tbody);
        content.appendChild(table);
        card.appendChild(content);

        const bulkUpdate = (field, value) => {
          if(!value) return; // Don't update if the value is empty (e.g., the placeholder on the select)
          state.groups[key].forEach(m => { m[field] = value; });
          saveToLS(); renderGroups();
          M.toast({html: `Updated ${field} for all in group.`});
        };
        card.querySelector('.bulk-transport-select').addEventListener('change', (e) => bulkUpdate('transport', e.target.value));
        card.querySelector('.bulk-date-input').addEventListener('change', (e) => bulkUpdate('date', e.target.value));
        card.querySelector('.bulk-time-input').addEventListener('change', (e) => bulkUpdate('time', e.target.value));
        card.querySelector('.bulk-instr-input').addEventListener('change', (e) => bulkUpdate('instructions', e.target.value));

        container.appendChild(card);
      }
      // This re-initializes all Materialize components. It is the correct fix for the scrolling issue.
      M.AutoInit();
    }

    document.getElementById('btn-add-save').addEventListener('click', ()=>{
      const m = {
        id: 'manual-'+Date.now(),
        type: document.getElementById('add-type').value,
        name: document.getElementById('add-name').value,
        originCity: normalizeZoneName(document.getElementById('add-origin').value),
        destinationCity: normalizeZoneName(document.getElementById('add-dest').value),
        destinationArea: document.getElementById('add-destarea').value,
        transport: document.getElementById('add-transport').value,
        date: document.getElementById('add-date').value,
        tbd: document.getElementById('add-tbd').checked,
        time: document.getElementById('add-time').value,
        instructions: document.getElementById('add-instructions').value,
        leader: document.getElementById('add-leader').checked
      };
      const key = `${m.originCity} -> ${m.destinationCity}`;
      if(!state.groups[key]) state.groups[key]=[];
      state.groups[key].push(m);
      saveToLS(); renderGroups();
      M.toast({html:'Added'});
    });

    function renderExceptions(){ const el = document.getElementById('exceptions-list'); el.innerHTML=''; for(const k of Object.keys(state.exceptions||{})){ const row = document.createElement('div'); row.className='row'; row.innerHTML = `<div class="col s4">${k}</div><div class="col s4">${state.exceptions[k].city || ''}</div><div class="col s4"><a data-key="${k}" class="btn-small red btn-ex-remove">Remove</a></div>`; el.appendChild(row); row.querySelector('.btn-ex-remove').addEventListener('click', (e)=>{ const keyToRemove = e.currentTarget.dataset.key; delete state.exceptions[keyToRemove]; saveToLS(); renderExceptions(); }); } }

    document.getElementById('btn-save-exception').addEventListener('click', () => {
      const nameInput = document.getElementById('ex-add-name');
      const cityInput = document.getElementById('ex-add-city');
      const name = nameInput.value.trim();
      const city = cityInput.value.trim();
      if (!name || !city) { M.toast({html: 'Please provide both a name and a city.'}); return; }
      if (!state.exceptions) state.exceptions = {};
      state.exceptions[name] = { city: city };
      saveToLS(); renderExceptions();
      M.toast({html: `Saved exception for ${name}.`});
      nameInput.value = ''; cityInput.value = '';
      M.updateTextFields();
    });

    document.getElementById('btn-delete-all').addEventListener('click', ()=>{ if(confirm('Delete ALL missionary travel? This will clear saved groups.')){ state.groups = {}; saveToLS(); renderGroups(); } });
    document.getElementById('btn-clear-local').addEventListener('click', ()=>{ if(confirm('Clear local storage? This will delete all saved travel and settings.')){ localStorage.removeItem(LS_KEY); state={groups:{},exceptions:defaults.exceptions}; loadState(); } });
    document.getElementById('lang-select').addEventListener('change', ()=>{ renderGroups(); });
    document.addEventListener('DOMContentLoaded', ()=>{ const ls = loadFromLS(); if(ls){ state=ls; } state.exceptions = Object.assign({}, defaults.exceptions, state.exceptions||{}); saveToLS(); renderExceptions(); renderGroups(); });
  </script>
</body>
</html>